var Web3 = require("web3");
var ethstarterContract = null;
var ethstarter = null;

//minage du contrat. Ceci correspond à l'initialisation du contrat.
module.exports.minerContrat = function(){
    var web3 = new Web3(new Web3.providers.HttpProvider("http://vps409515.ovh.net:8545"));
    ethstarterContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_id","type":"uint256"},{"name":"_estEnCours","type":"bool"}],"name":"setEstEnCours","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"}],"name":"sendToContributors","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"nbCrowfundings","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"crowfundings","outputs":[{"name":"addrContractor","type":"address"},{"name":"goal","type":"uint256"},{"name":"maxGoal","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"nbContributors","type":"uint256"},{"name":"estEnCours","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"balance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"},{"name":"_goal","type":"uint256"},{"name":"_maxGoal","type":"uint256"}],"name":"addCrowfunding","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"}],"name":"getGoal","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"}],"name":"sendToContractor","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_idCrowfundig","type":"uint256"}],"name":"addContributor","outputs":[],"payable":true,"stateMutability":"payable","type":"function"}]);
    ethstarter = ethstarterContract.new(
        {
            from: web3.eth.accounts[0],
            data: '0x6060604052341561000f57600080fd5b6106fd8061001e6000396000f300606060405260043610610099576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806367a1a2941461009e5780638b540c37146100cc57806391d6d035146100ef5780639f7acff814610118578063b69ef8a8146101a2578063d855519b146101cb578063df6ed6cb146101f5578063eba449451461022c578063f56c882a1461024f575b600080fd5b34156100a957600080fd5b6100ca60048080359060200190919080351515906020019091905050610267565b005b34156100d757600080fd5b6100ed600480803590602001909190505061029e565b005b34156100fa57600080fd5b610102610384565b6040518082815260200191505060405180910390f35b341561012357600080fd5b610139600480803590602001909190505061038a565b604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200186815260200185815260200184815260200183815260200182151515158152602001965050505050505060405180910390f35b34156101ad57600080fd5b6101b56103f3565b6040518082815260200191505060405180910390f35b6101f360048080359060200190919080359060200190919080359060200190919050506103f9565b005b341561020057600080fd5b6102166004808035906020019091905050610518565b6040518082815260200191505060405180910390f35b341561023757600080fd5b61024d6004808035906020019091905050610537565b005b61026560048080359060200190919050506105d7565b005b60008060008481526020019081526020016000209050818160050160006101000a81548160ff021916908315150217905550505050565b60008060008060008581526020019081526020016000209250600091505b826004015482101561037e5782600601600083815260200190815260200160002090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82600101549081150290604051600060405180830381858888f19350505050151561034757600080fd5b80600101548360030160008282540392505081905550806001015460026000828254039250508190555081806001019250506102bc565b50505050565b60015481565b60006020528060005260406000206000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030154908060040154908060050160009054906101000a900460ff16905086565b60025481565b60016000815480929190600101919050555060c0604051908101604052803373ffffffffffffffffffffffffffffffffffffffff16815260200183815260200182815260200160008152602001600081526020016001151581525060008085815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015560408201518160020155606082015181600301556080820151816004015560a08201518160050160006101000a81548160ff021916908315150217905550905050600080600085815260200190815260200160002060030181905550505050565b6000806000838152602001908152602001600020600101549050919050565b600080600083815260200190815260200160002090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82600301549081150290604051600060405180830381858888f1935050505015156105b557600080fd5b8060030154600260008282540392505081905550600081600301819055505050565b600080600083815260200190815260200160002090508060050160009054906101000a900460ff16156106cd5760408051908101604052803373ffffffffffffffffffffffffffffffffffffffff1681526020013481525081600601600083600401600081548092919060010191905055815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155905050348160030160008282540192505081905550346002600082825401925050819055505b50505600a165627a7a72305820d348a022d6855817880caacf5c5d48618fa5e20ac86473b602a065c29e9cebaa0029',
            gas: '4700000'
        }, function (e, contract){
            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        })
};
//Retourne le nombre de campagnes de financement
module.exports.getNbCrowfundings = function () {
    return ethstarter.nbCrowfundings.call();
};
module.exports.getBalance = function () {
    return ethstarter.balance.call();
};
//Fonction qui ajoute une campagne de financement au contrat. Ne surtout pas oublier de mettre le coût en gas, sinon ça met une erreur.
//A modifier ^^. C'était juste pour tester !
module.exports.addCrowfunding = function(){
    var web3 = new Web3(new Web3.providers.HttpProvider("http://vps409515.ovh.net:8545"));
    return ethstarter.addCrowfunding(1, 10, 12, {from: web3.eth.accounts[0], gas: 3000000});
};