var Web3 = require("web3");
var ethstarterContract = null;
var ethstarter = null;

//minage du contrat. Ceci correspond à l'initialisation du contrat.
module.exports.minerContrat = function(){
    var web3 = new Web3(new Web3.providers.HttpProvider("http://vps409515.ovh.net:8545"));
    ethstarterContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_id","type":"uint256"},{"name":"_estEnCours","type":"bool"}],"name":"setEstEnCours","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"}],"name":"sendToContributors","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"nbCrowfundings","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"crowfundings","outputs":[{"name":"addrContractor","type":"address"},{"name":"goal","type":"uint256"},{"name":"maxGoal","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"nbContributors","type":"uint256"},{"name":"estEnCours","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"},{"name":"_goal","type":"uint256"},{"name":"_maxGoal","type":"uint256"}],"name":"addCrowfunding","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"uint256"}],"name":"sendToContractor","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_idCrowfundig","type":"uint256"}],"name":"addContributor","outputs":[],"payable":true,"stateMutability":"payable","type":"function"}]);
    ethstarter = ethstarterContract.new(
        {
            from: web3.eth.accounts[0],
            data: '0x6060604052341561000f57600080fd5b61062a8061001e6000396000f300606060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806367a1a294146100885780638b540c37146100b657806391d6d035146100d95780639f7acff814610102578063d855519b1461018c578063eba44945146101b6578063f56c882a146101d9575b600080fd5b341561009357600080fd5b6100b4600480803590602001909190803515159060200190919050506101f1565b005b34156100c157600080fd5b6100d76004808035906020019091905050610228565b005b34156100e457600080fd5b6100ec6102fa565b6040518082815260200191505060405180910390f35b341561010d57600080fd5b6101236004808035906020019091905050610300565b604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200186815260200185815260200184815260200183815260200182151515158152602001965050505050505060405180910390f35b6101b46004808035906020019091908035906020019091908035906020019091905050610369565b005b34156101c157600080fd5b6101d76004808035906020019091905050610488565b005b6101ef6004808035906020019091905050610514565b005b60008060008481526020019081526020016000209050818160050160006101000a81548160ff021916908315150217905550505050565b60008060008060008581526020019081526020016000209250600091505b82600401548210156102f45782600601600083815260200190815260200160002090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82600101549081150290604051600060405180830381858888f1935050505015156102d157600080fd5b806001015483600301600082825403925050819055508180600101925050610246565b50505050565b60015481565b60006020528060005260406000206000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030154908060040154908060050160009054906101000a900460ff16905086565b60016000815480929190600101919050555060c0604051908101604052803373ffffffffffffffffffffffffffffffffffffffff16815260200183815260200182815260200160008152602001600081526020016001151581525060008085815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015560408201518160020155606082015181600301556080820151816004015560a08201518160050160006101000a81548160ff021916908315150217905550905050600080600085815260200190815260200160002060030181905550505050565b600080600083815260200190815260200160002090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82600301549081150290604051600060405180830381858888f19350505050151561050657600080fd5b600081600301819055505050565b600080600083815260200190815260200160002090508060050160009054906101000a900460ff16156105fa5760408051908101604052803373ffffffffffffffffffffffffffffffffffffffff1681526020013481525081600601600083600401600081548092919060010191905055815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101559050503481600301600082825401925050819055505b50505600a165627a7a7230582067e102c515a7e01f0ddb97e809ed3bb0493b369f707f8965c2132304bf9bd59c0029',
            gas: '4700000'
        }, function (e, contract){
            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        })
};
//Retourne le nombre de campagnes de financement
module.exports.getNbCrowfundings = function () {
    return ethstarter.nbCrowfundings.call();
};
//Fonction qui ajoute une campagne de financement au contrat. Ne surtout pas oublier de mettre le coût en gas, sinon ça met une erreur.
module.exports.addCrowfunding = function(){
    var web3 = new Web3(new Web3.providers.HttpProvider("http://vps409515.ovh.net:8545"));
    return ethstarter.addCrowfunding(1, 10, 12, {from: web3.eth.accounts[0], gas: 3000000});
};